ğŸ› bug#5378 ã€è¿›åº¦ç®¡ç†ã€‘è¿›åº¦åˆ†æ-é¢†å–äººä¸ºç©º
<template>
  <div class="year-main">
    <el-row :gutter="20">
      <el-col :span="12">
        <div>
          <v-chart :options="options1"></v-chart>
          <vxe-table ref="table1" :data="data1" size="mini">
            <vxe-table-column field="name" width="120px">
              <template slot="header">{{ year }}å¹´</template>
            </vxe-table-column>
            <vxe-table-column title="1æœˆ" field="data[0]"></vxe-table-column>
            <vxe-table-column title="2æœˆ" field="data[1]"></vxe-table-column>
            <vxe-table-column title="3æœˆ" field="data[2]"></vxe-table-column>
            <vxe-table-column title="4æœˆ" field="data[3]"></vxe-table-column>
            <vxe-table-column title="5æœˆ" field="data[4]"></vxe-table-column>
            <vxe-table-column title="6æœˆ" field="data[5]"></vxe-table-column>
            <vxe-table-column title="7æœˆ" field="data[6]"></vxe-table-column>
            <vxe-table-column title="8æœˆ" field="data[7]"></vxe-table-column>
            <vxe-table-column title="9æœˆ" field="data[8]"></vxe-table-column>
            <vxe-table-column title="10æœˆ" field="data[9]"></vxe-table-column>
            <vxe-table-column title="11æœˆ" field="data[10]"></vxe-table-column>
            <vxe-table-column title="12æœˆ" field="data[11]"></vxe-table-column>
            <vxe-table-column title="æ€»è®¡" field="total"></vxe-table-column>
          </vxe-table>
        </div>
      </el-col>
      <el-col :span="12">
        <div>
          <v-chart :options="options2"></v-chart>
          <vxe-table ref="table2" :data="data2" size="mini" :span-method="colspanMethod">
            <vxe-table-column field="companyName" :show-overflow="false"></vxe-table-column>
            <vxe-table-column field="name" width="120px">
              <template slot="header">{{ year }}å¹´</template>
            </vxe-table-column>
            <vxe-table-column title="1æœˆ" field="data[0]"></vxe-table-column>
            <vxe-table-column title="2æœˆ" field="data[1]"></vxe-table-column>
            <vxe-table-column title="3æœˆ" field="data[2]"></vxe-table-column>
            <vxe-table-column title="4æœˆ" field="data[3]"></vxe-table-column>
            <vxe-table-column title="5æœˆ" field="data[4]"></vxe-table-column>
            <vxe-table-column title="6æœˆ" field="data[5]"></vxe-table-column>
            <vxe-table-column title="7æœˆ" field="data[6]"></vxe-table-column>
            <vxe-table-column title="8æœˆ" field="data[7]"></vxe-table-column>
            <vxe-table-column title="9æœˆ" field="data[8]"></vxe-table-column>
            <vxe-table-column title="10æœˆ" field="data[9]"></vxe-table-column>
            <vxe-table-column title="11æœˆ" field="data[10]"></vxe-table-column>
            <vxe-table-column title="12æœˆ" field="data[11]"></vxe-table-column>
            <vxe-table-column title="æ€»è®¡" field="total"></vxe-table-column>
          </vxe-table>
        </div>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import api from '../../api'

export default {
  name: 'Year',
  // importå¼•å…¥çš„ç»„ä»¶éœ€è¦æ³¨å…¥åˆ°å¯¹è±¡ä¸­æ‰èƒ½ä½¿ç”¨
  components: {},
  props: {
    year: {
      type: Number
    },
    month: {
      type: Number
    }
  },
  data() {
    // è¿™é‡Œå­˜æ”¾æ•°æ®
    return {
      options1: {
        title: {
          text: moment().year() + 'å¹´åº¦åˆ†ææŸ±çŠ¶å›¾',
          top: 'bottom',
          left: 'center',
          textStyle: {
            fontSize: 16,
            color: '#555'
          }
        },
        color: ['#feb64d', '#5bc49f', '#fb6e6c'],
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          }
        },
        legend: {
          data: ['æ­£å¸¸å®Œæˆæ•°é‡', 'è¶…å‰å®Œæˆæ•°é‡', 'æ»åå»¶æœŸæ•°é‡']
        },
        xAxis: [
          {
            type: 'category',
            axisTick: { show: false },
            data: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ']
          }
        ],
        yAxis: [
          {
            name: 'æ•°é‡',
            type: 'value'
          }
        ],
        series: []
      },
      // ä¸åŒå•ä½å®Œæˆè¿›åº¦æ•°é‡
      options2: {
        title: {
          text: moment().year() + 'å¹´ä¸åŒå•ä½å®Œæˆè¿›åº¦æ•°é‡å æ¯”ç»Ÿè®¡',
          top: 'bottom',
          left: 'center',
          textStyle: {
            fontSize: 16,
            color: '#555'
          }
        },
        legend: {
          data: ['æ­£å¸¸å®Œæˆ', 'è¶…å‰å®Œæˆ', 'æ»åå»¶æœŸ']
        },
        xAxis: [
          {
            name: 'å•ä½åç§°',
            type: 'category',
            axisTick: { show: false },
            data: []
          }
        ],
        yAxis: [
          {
            name: 'æ•°é‡',
            type: 'value'
          }
        ],
        tooltip: {
          trigger: 'axis'
        },
        color: ['#feb64d', '#5bc49f', '#fb6e6c', '#ffdc5c', '#ff9f7f', '#38a1da'],
        series: []
      },
      // å¹´è¿›åº¦æ€»æ•°æ®å¯¹æ¯”åˆ†æè¡¨
      data1: [],
      // å¹´å„å•ä½å®Œæˆæƒ…å†µåˆ†æè¡¨
      data2: []
    }
  },
  watch: {
    year() {
      this.options1.title.text = this.year + `å¹´åº¦è¿›åº¦åˆ†ææŸ±çŠ¶å›¾`
      this.options2.title.text = this.year + `å¹´ä¸åŒå•ä½å®Œæˆè¿›åº¦æ•°é‡å æ¯”ç»Ÿè®¡`
      this.refresh()
    }
  },
  // ç”Ÿå‘½å‘¨æœŸ - å®ä¾‹åˆ›å»ºå®Œæˆï¼Œå¯è®¿é—®dataã€computedã€watchã€methodsä¸Šçš„æ–¹æ³•å’Œæ•°æ®ï¼ŒæœªæŒ‚è½½åˆ°DOMï¼Œä¸èƒ½è®¿é—®åˆ°å±æ€§ï¼Œå±æ€§å†…å®¹ä¸ºç©ºæ•°ç»„
  created() {
    this.refresh()
  },
  // ç”Ÿå‘½å‘¨æœŸ - å®ä¾‹æŒ‚è½½åˆ°DOMä¸Šï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡DOM APIè·å–åˆ°DOMèŠ‚ç‚¹ï¼Œå±æ€§å¯ä»¥è®¿é—®
  mounted() {},
  // æ–¹æ³•é›†åˆ
  methods: {
    // åˆ·æ–°ä¸»è¦æ•°æ®,ä¸€èˆ¬è¡¨æ ¼é¡µé¢ä¸ºåˆ·æ–°åˆ—è¡¨ï¼Œè¯¦æƒ…é¡µé¢ä¸ºåˆ·æ–°è¯¦æƒ…
    refresh() {
      api
        .getPeriodAnalyze({
          cycleType: 1,
          start: moment().year(this.year).startOf('year').format('YYYY-MM-DD 00:00:00'),
          end: moment().year(this.year).endOf('year').format('YYYY-MM-DD 23:59:59')
        })
        .then(res => {
          let arr = []
          for (let i = 1; i < 13; i++) {
            arr.push(res.data[i])
          }
          this.data1 = [
            {
              name: 'æ­£å¸¸å®Œæˆæ•°é‡',
              data: _.map(arr, 'normalFinishedNum'),
              total: _.sumBy(arr, 'normalFinishedNum')
            },
            {
              name: 'è¶…å‰å®Œæˆæ•°é‡',
              data: _.map(arr, 'advanceFinishedNum'),
              total: _.sumBy(arr, 'advanceFinishedNum')
            },
            {
              name: 'è¶…å‰ (å¤©)',
              data: _.map(arr, 'advanceDayNum'),
              total: _.sumBy(arr, 'advanceDayNum')
            },
            {
              name: 'æ»åå»¶æœŸæ•°é‡',
              data: _.map(arr, 'delayFinishedNum'),
              total: _.sumBy(arr, 'delayFinishedNum')
            },
            {
              name: 'æ»å (å¤©)',
              data: _.map(arr, 'delayDayNum'),
              total: _.sumBy(arr, 'delayDayNum')
            }
          ]
          this.options1.xAxis[0].name = this.year + 'å¹´'
          this.options1.series = [
            {
              name: 'æ­£å¸¸å®Œæˆæ•°é‡',
              type: 'bar',
              data: _.map(arr, 'normalFinishedNum')
            },
            {
              name: 'è¶…å‰å®Œæˆæ•°é‡',
              type: 'bar',
              data: _.map(arr, 'advanceFinishedNum')
            },
            {
              name: 'æ»åå»¶æœŸæ•°é‡',
              type: 'bar',
              data: _.map(arr, 'delayFinishedNum')
            }
          ]
        })
      api
        .getCompanyPeriodAnalyze({
          cycleType: 1,
          start: moment().year(this.year).startOf('year').format('YYYY-MM-DD 00:00:00'),
          end: moment().year(this.year).endOf('year').format('YYYY-MM-DD 23:59:59')
        })
        .then(res => {
          let prettyDataHash = _.mapValues(res.data, (v, k) => {
            let arr = []
            for (let i = 1; i < 13; i++) {
              arr.push(v[i])
            }
            return [
              {
                companyName: k,
                name: 'æ­£å¸¸å®Œæˆæ•°é‡',
                data: _.map(arr, 'normalFinishedNum'),
                total: _.sumBy(arr, 'normalFinishedNum')
              },
              {
                companyName: k,
                name: 'è¶…å‰å®Œæˆæ•°é‡',
                data: _.map(arr, 'advanceFinishedNum'),
                total: _.sumBy(arr, 'advanceFinishedNum')
              },
              {
                name: 'è¶…å‰ (å¤©)',
                data: _.map(arr, 'advanceDayNum'),
                total: _.sumBy(arr, 'advanceDayNum')
              },
              {
                companyName: k,
                name: 'æ»åå»¶æœŸæ•°é‡',
                data: _.map(arr, 'delayFinishedNum'),
                total: _.sumBy(arr, 'delayFinishedNum')
              },
              {
                name: 'æ»å (å¤©)',
                data: _.map(arr, 'delayDayNum'),
                total: _.sumBy(arr, 'delayDayNum')
              }
            ]
          })
          let prettyDataArray = _.values(prettyDataHash)
          this.data2 = _.flatten(prettyDataArray)
          this.options2.xAxis[0].data = _.map(prettyDataArray, '0.companyName')
          this.options2.series = [
            {
              name: 'æ­£å¸¸å®Œæˆ',
              type: 'bar',
              data: _.map(prettyDataArray, '0.total')
            },
            {
              name: 'è¶…å‰å®Œæˆ',
              type: 'bar',
              data: _.map(prettyDataArray, '1.total')
            },
            {
              name: 'æ»åå»¶æœŸ',
              type: 'bar',
              data: _.map(prettyDataArray, '3.total')
            }
          ]
        })
    },
    // å•å…ƒæ ¼åˆå¹¶æ–¹æ³•
    colspanMethod({ rowIndex, columnIndex }) {
      if (columnIndex === 0) {
        if (rowIndex % 5 === 0) {
          return { rowspan: 5, colspan: 1 }
        } else {
          return {
            rowspan: 0,
            colspan: 1
          }
        }
      } else {
        return {
          rowspan: 1,
          colspan: 1
        }
      }
    }
  }
}
</script>

<style scoped lang="less">
@import '~@/styles/color.less';
.el-row {
  .el-col {
    > div {
      padding: 15px;
      background-color: #fff;
      display: flex;
      align-items: center;
      flex-direction: column;
      .vxe-table {
        margin-top: 30px;
        width: 100%;
      }
    }
  }
}
.echarts {
  width: 100%;
}
.table-header-split {
  height: 35px;
  width: 95px;
  position: relative;
  span {
    &:first-child {
      position: absolute;
      bottom: -2px;
      left: 0;
    }
    &:last-child {
      position: absolute;
      top: 0;
      right: 0;
    }
  }
}
</style>
<style>
.tilt-line:after {
  width: 100%;
  height: 100%;
  content: '';
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='47'><path d='M 0 0 l 120 47' stroke='rgb(200, 200, 200)' stroke-width='1px'></path><rect fill='url(%23gradient)' x='0' y='0' width='100%' height='100%'/></svg>")
    no-repeat center;
}
</style>
